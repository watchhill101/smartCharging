<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººè„¸ç™»å½•æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .test-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin: 20px 0;
            border-radius: 15px;
        }

        .camera-container {
            width: 100%;
            height: 300px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            margin: 20px 0;
        }

        .camera-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }

        .status.success {
            background: rgba(76, 175, 80, 0.3);
        }

        .status.error {
            background: rgba(244, 67, 54, 0.3);
        }

        .status.info {
            background: rgba(33, 150, 243, 0.3);
        }

        .status.warning {
            background: rgba(255, 152, 0, 0.3);
        }

        .log {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }

        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .feature-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .feature-item.supported {
            border: 2px solid #4CAF50;
        }

        .feature-item.not-supported {
            border: 2px solid #f44336;
            opacity: 0.6;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ­ äººè„¸ç™»å½•åŠŸèƒ½æµ‹è¯•</h1>
            <p>æµ‹è¯•æµè§ˆå™¨å…¼å®¹æ€§å’ŒåŠŸèƒ½å®Œæ•´æ€§</p>
        </div>

        <!-- ç¯å¢ƒæ£€æµ‹ -->
        <div class="test-section">
            <h2>ğŸ“‹ ç¯å¢ƒæ£€æµ‹</h2>
            <div class="feature-list" id="features">
                <!-- åŠŸèƒ½æ”¯æŒæ£€æµ‹ç»“æœä¼šåŠ¨æ€æ’å…¥è¿™é‡Œ -->
            </div>
        </div>

        <!-- æ‘„åƒå¤´æµ‹è¯• -->
        <div class="test-section">
            <h2>ğŸ“¹ æ‘„åƒå¤´æµ‹è¯•</h2>
            <div class="camera-container" id="cameraContainer">
                <div
                    style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 18px;">
                    ç‚¹å‡»"å¯åŠ¨æ‘„åƒå¤´"å¼€å§‹æµ‹è¯•
                </div>
            </div>
            <div class="controls">
                <button onclick="startCamera()">å¯åŠ¨æ‘„åƒå¤´</button>
                <button onclick="stopCamera()">åœæ­¢æ‘„åƒå¤´</button>
                <button onclick="captureImage()">æ‹ç…§æµ‹è¯•</button>
            </div>
            <div id="cameraStatus" class="status info">ç­‰å¾…å¯åŠ¨æ‘„åƒå¤´...</div>
        </div>

        <!-- APIæµ‹è¯• -->
        <div class="test-section">
            <h2>ğŸ”Œ APIè¿æ¥æµ‹è¯•</h2>
            <div class="controls">
                <button onclick="testHealthCheck()">å¥åº·æ£€æŸ¥</button>
                <button onclick="testFaceDetection()">äººè„¸æ£€æµ‹</button>
                <button onclick="testFaceLogin()">äººè„¸ç™»å½•</button>
            </div>
            <div id="apiStatus" class="status info">ç­‰å¾…æµ‹è¯•APIè¿æ¥...</div>
        </div>

        <!-- æ—¥å¿—è¾“å‡º -->
        <div class="test-section">
            <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
            <div class="controls">
                <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
                <button onclick="downloadLog()">ä¸‹è½½æ—¥å¿—</button>
            </div>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        let currentStream = null;
        let videoElement = null;
        const logElement = document.getElementById('log');

        // æ—¥å¿—å‡½æ•°
        function log(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${level.toUpperCase()}: ${message}`;
            console.log(logEntry);
            logElement.innerHTML += logEntry + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // æ£€æµ‹æµè§ˆå™¨åŠŸèƒ½æ”¯æŒ
        function checkBrowserSupport() {
            const features = [
                {
                    name: 'åª’ä½“è®¾å¤‡API',
                    supported: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
                    icon: 'ğŸ“¹'
                },
                {
                    name: 'Canvas API',
                    supported: !!(document.createElement('canvas').getContext),
                    icon: 'ğŸ¨'
                },
                {
                    name: 'Fetch API',
                    supported: !!(window.fetch),
                    icon: 'ğŸ”—'
                },
                {
                    name: 'FormData API',
                    supported: !!(window.FormData),
                    icon: 'ğŸ“„'
                },
                {
                    name: 'Blob API',
                    supported: !!(window.Blob),
                    icon: 'ğŸ’¾'
                },
                {
                    name: 'Promise æ”¯æŒ',
                    supported: !!(window.Promise),
                    icon: 'â°'
                },
                {
                    name: 'HTTPS ç¯å¢ƒ',
                    supported: location.protocol === 'https:' || location.hostname === 'localhost',
                    icon: 'ğŸ”’'
                }
            ];

            const featuresContainer = document.getElementById('features');
            featuresContainer.innerHTML = '';

            features.forEach(feature => {
                const div = document.createElement('div');
                div.className = `feature-item ${feature.supported ? 'supported' : 'not-supported'}`;
                div.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 10px;">${feature.icon}</div>
                    <div style="font-weight: bold;">${feature.name}</div>
                    <div style="margin-top: 5px; ${feature.supported ? 'color: #4CAF50' : 'color: #f44336'}">
                        ${feature.supported ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}
                    </div>
                `;
                featuresContainer.appendChild(div);

                log('info', `${feature.name}: ${feature.supported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}`);
            });

            return features.every(f => f.supported);
        }

        // å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            try {
                updateStatus('cameraStatus', 'æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...', 'info');
                log('info', 'è¯·æ±‚æ‘„åƒå¤´æƒé™...');

                const constraints = {
                    video: {
                        width: { ideal: 640, min: 320 },
                        height: { ideal: 480, min: 240 },
                        facingMode: 'user'
                    },
                    audio: false
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                log('success', 'æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ');

                // åˆ›å»ºvideoå…ƒç´ 
                videoElement = document.createElement('video');
                videoElement.srcObject = currentStream;
                videoElement.autoplay = true;
                videoElement.playsInline = true;
                videoElement.muted = true;
                videoElement.style.width = '100%';
                videoElement.style.height = '100%';
                videoElement.style.objectFit = 'cover';
                videoElement.style.transform = 'scaleX(-1)';

                const container = document.getElementById('cameraContainer');
                container.innerHTML = '';
                container.appendChild(videoElement);

                videoElement.onloadeddata = () => {
                    log('success', `è§†é¢‘å°ºå¯¸: ${videoElement.videoWidth}x${videoElement.videoHeight}`);
                    updateStatus('cameraStatus', 'æ‘„åƒå¤´è¿è¡Œæ­£å¸¸', 'success');
                };

            } catch (error) {
                log('error', `æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: ${error.message}`);
                updateStatus('cameraStatus', `æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åœæ­¢æ‘„åƒå¤´
        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
                log('info', 'æ‘„åƒå¤´å·²åœæ­¢');
            }

            const container = document.getElementById('cameraContainer');
            container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 18px;">æ‘„åƒå¤´å·²åœæ­¢</div>';
            updateStatus('cameraStatus', 'æ‘„åƒå¤´å·²åœæ­¢', 'info');
        }

        // æ‹ç…§æµ‹è¯•
        async function captureImage() {
            if (!videoElement || !currentStream) {
                log('error', 'è¯·å…ˆå¯åŠ¨æ‘„åƒå¤´');
                return;
            }

            try {
                log('info', 'å¼€å§‹æ‹ç…§...');

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                canvas.width = videoElement.videoWidth || 640;
                canvas.height = videoElement.videoHeight || 480;

                context.scale(-1, 1);
                context.drawImage(videoElement, -canvas.width, 0, canvas.width, canvas.height);

                const blob = await new Promise((resolve, reject) => {
                    canvas.toBlob(blob => {
                        if (blob) resolve(blob);
                        else reject(new Error('å›¾åƒæ•è·å¤±è´¥'));
                    }, 'image/jpeg', 0.85);
                });

                log('success', `å›¾åƒæ•è·æˆåŠŸï¼Œå¤§å°: ${blob.size} bytes`);

                // æ˜¾ç¤ºæ‹ç…§ç»“æœ
                const url = URL.createObjectURL(blob);
                const img = document.createElement('img');
                img.src = url;
                img.style.maxWidth = '200px';
                img.style.border = '2px solid #4CAF50';
                img.style.borderRadius = '10px';
                img.style.margin = '10px';

                const container = document.getElementById('cameraContainer');
                const existingImg = container.querySelector('img');
                if (existingImg) existingImg.remove();
                container.appendChild(img);

            } catch (error) {
                log('error', `æ‹ç…§å¤±è´¥: ${error.message}`);
            }
        }

        // APIæµ‹è¯•
        async function testHealthCheck() {
            try {
                log('info', 'æµ‹è¯•åç«¯å¥åº·æ£€æŸ¥...');
                updateStatus('apiStatus', 'æ£€æŸ¥åç«¯è¿æ¥...', 'info');

                const response = await fetch('http://localhost:8080/health');
                const data = await response.json();

                if (data.status === 'OK') {
                    log('success', 'åç«¯æœåŠ¡æ­£å¸¸');
                    updateStatus('apiStatus', 'åç«¯æœåŠ¡è¿æ¥æ­£å¸¸', 'success');
                } else {
                    throw new Error('åç«¯æœåŠ¡çŠ¶æ€å¼‚å¸¸');
                }
            } catch (error) {
                log('error', `å¥åº·æ£€æŸ¥å¤±è´¥: ${error.message}`);
                updateStatus('apiStatus', `åç«¯è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testFaceDetection() {
            if (!videoElement) {
                log('error', 'è¯·å…ˆå¯åŠ¨æ‘„åƒå¤´å¹¶æ‹ç…§');
                return;
            }

            try {
                log('info', 'æµ‹è¯•äººè„¸æ£€æµ‹API...');

                // å…ˆæ‹ç…§
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = videoElement.videoWidth || 640;
                canvas.height = videoElement.videoHeight || 480;
                context.drawImage(videoElement, 0, 0);

                const blob = await new Promise((resolve) => {
                    canvas.toBlob(resolve, 'image/jpeg', 0.85);
                });

                const formData = new FormData();
                formData.append('image', blob, 'test.jpg');

                const response = await fetch('http://localhost:8080/api/face/detect', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    log('success', `äººè„¸æ£€æµ‹æˆåŠŸ: ${JSON.stringify(result.data, null, 2)}`);
                } else {
                    log('error', `äººè„¸æ£€æµ‹å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                log('error', `äººè„¸æ£€æµ‹APIæµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        async function testFaceLogin() {
            log('info', 'äººè„¸ç™»å½•æµ‹è¯•éœ€è¦å…ˆæ³¨å†Œäººè„¸æ¡£æ¡ˆ');
            log('info', 'è¯·ä½¿ç”¨åç«¯æµ‹è¯•è„šæœ¬å…ˆåˆ›å»ºç”¨æˆ·å’Œäººè„¸æ¡£æ¡ˆ');
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            logElement.innerHTML = '';
        }

        // ä¸‹è½½æ—¥å¿—
        function downloadLog() {
            const logContent = logElement.textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `face-login-test-${new Date().toISOString().split('T')[0]}.log`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // é¡µé¢åŠ è½½æ—¶è¿›è¡Œåˆå§‹åŒ–æ£€æµ‹
        window.onload = function () {
            log('info', 'å¼€å§‹äººè„¸ç™»å½•åŠŸèƒ½æµ‹è¯•');
            log('info', `æµè§ˆå™¨: ${navigator.userAgent}`);
            log('info', `å½“å‰URL: ${location.href}`);

            const allSupported = checkBrowserSupport();

            if (allSupported) {
                log('success', 'æ‰€æœ‰å¿…éœ€åŠŸèƒ½éƒ½å—æ”¯æŒ');
            } else {
                log('warning', 'éƒ¨åˆ†åŠŸèƒ½ä¸å—æ”¯æŒï¼Œå¯èƒ½å½±å“äººè„¸ç™»å½•åŠŸèƒ½');
            }
        };
    </script>
</body>

</html>