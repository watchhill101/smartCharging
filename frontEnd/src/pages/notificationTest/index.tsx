import { View, Text, Button } from '@tarojs/components'\nimport { useState } from 'react'\nimport Taro from '@tarojs/taro'\nimport { useNotification } from '../../contexts/NotificationContext'\nimport request from '../../utils/request'\nimport './index.scss'\n\nconst NotificationTest: React.FC = () => {\n  const [isLoading, setIsLoading] = useState(false)\n  const [testResults, setTestResults] = useState<string[]>([])\n  const { \n    notifications, \n    unreadCount, \n    isConnected, \n    error,\n    refreshNotifications,\n    reconnect\n  } = useNotification()\n\n  const addTestResult = (message: string) => {\n    setTestResults(prev => [...prev, `${new Date().toLocaleTimeString()}: ${message}`])\n  }\n\n  const runTest = async (testType: string, testName: string) => {\n    setIsLoading(true)\n    addTestResult(`å¼€å§‹${testName}æµ‹è¯•...`)\n    \n    try {\n      const response = await request({\n        url: `/notification-test/${testType}`,\n        method: 'POST'\n      })\n\n      if (response.data.success) {\n        addTestResult(`âœ… ${testName}æµ‹è¯•æˆåŠŸ: ${response.data.message}`)\n      } else {\n        addTestResult(`âŒ ${testName}æµ‹è¯•å¤±è´¥: ${response.data.message}`)\n      }\n    } catch (error: any) {\n      console.error(`${testName}æµ‹è¯•å¤±è´¥:`, error)\n      addTestResult(`âŒ ${testName}æµ‹è¯•å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`)\n    } finally {\n      setIsLoading(false)\n    }\n  }\n\n  const runFullSuite = async () => {\n    setIsLoading(true)\n    addTestResult('å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶...')\n    \n    try {\n      const response = await request({\n        url: '/notification-test/run-full-suite',\n        method: 'POST'\n      })\n\n      if (response.data.success) {\n        addTestResult(`âœ… æµ‹è¯•å¥—ä»¶å¯åŠ¨æˆåŠŸ: ${response.data.message}`)\n        addTestResult('è¯·è§‚å¯Ÿé€šçŸ¥ä¸­å¿ƒçš„å®æ—¶é€šçŸ¥')\n      } else {\n        addTestResult(`âŒ æµ‹è¯•å¥—ä»¶å¯åŠ¨å¤±è´¥: ${response.data.message}`)\n      }\n    } catch (error: any) {\n      console.error('æµ‹è¯•å¥—ä»¶å¯åŠ¨å¤±è´¥:', error)\n      addTestResult(`âŒ æµ‹è¯•å¥—ä»¶å¯åŠ¨å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`)\n    } finally {\n      setIsLoading(false)\n    }\n  }\n\n  const getWebSocketStatus = async () => {\n    try {\n      const response = await request({\n        url: '/notification-test/websocket-status',\n        method: 'GET'\n      })\n\n      if (response.data.success) {\n        const { data } = response.data\n        addTestResult(`ğŸ“¡ WebSocketçŠ¶æ€:`)\n        addTestResult(`   - æœåŠ¡å·²åˆå§‹åŒ–: ${data.isInitialized ? 'æ˜¯' : 'å¦'}`)\n        addTestResult(`   - åœ¨çº¿ç”¨æˆ·æ•°: ${data.onlineUsers}`)\n        addTestResult(`   - å½“å‰ç”¨æˆ·åœ¨çº¿: ${data.isCurrentUserOnline ? 'æ˜¯' : 'å¦'}`)\n      }\n    } catch (error: any) {\n      addTestResult(`âŒ è·å–WebSocketçŠ¶æ€å¤±è´¥: ${error.message}`)\n    }\n  }\n\n  const clearResults = () => {\n    setTestResults([])\n  }\n\n  const handleReconnect = () => {\n    addTestResult('å°è¯•é‡æ–°è¿æ¥WebSocket...')\n    reconnect()\n  }\n\n  return (\n    <View className='notification-test'>\n      <View className='test-header'>\n        <Text className='page-title'>é€šçŸ¥ç³»ç»Ÿæµ‹è¯•</Text>\n        \n        <View className='connection-status'>\n          <View className={`status-indicator ${isConnected ? 'connected' : 'disconnected'}`} />\n          <Text className='status-text'>\n            {isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}\n          </Text>\n          {error && (\n            <Text className='error-text'>({error})</Text>\n          )}\n        </View>\n      </View>\n\n      <View className='notification-stats'>\n        <View className='stat-item'>\n          <Text className='stat-number'>{notifications.length}</Text>\n          <Text className='stat-label'>æ€»é€šçŸ¥</Text>\n        </View>\n        <View className='stat-item'>\n          <Text className='stat-number unread'>{unreadCount}</Text>\n          <Text className='stat-label'>æœªè¯»</Text>\n        </View>\n      </View>\n\n      <View className='test-controls'>\n        <View className='control-section'>\n          <Text className='section-title'>è¿æ¥æ§åˆ¶</Text>\n          <View className='button-row'>\n            <Button \n              className='test-btn'\n              size='mini'\n              onClick={getWebSocketStatus}\n              disabled={isLoading}\n            >\n              æ£€æŸ¥è¿æ¥çŠ¶æ€\n            </Button>\n            <Button \n              className='test-btn'\n              size='mini'\n              onClick={handleReconnect}\n              disabled={isLoading || isConnected}\n            >\n              é‡æ–°è¿æ¥\n            </Button>\n            <Button \n              className='test-btn'\n              size='mini'\n              onClick={refreshNotifications}\n              disabled={isLoading}\n            >\n              åˆ·æ–°é€šçŸ¥\n            </Button>\n          </View>\n        </View>\n\n        <View className='control-section'>\n          <Text className='section-title'>å•é¡¹æµ‹è¯•</Text>\n          <View className='button-grid'>\n            <Button \n              className='test-btn'\n              size='mini'\n              onClick={() => runTest('test-charging', 'å……ç”µé€šçŸ¥')}\n              disabled={isLoading}\n            >\n              å……ç”µé€šçŸ¥\n            </Button>\n            <Button \n              className='test-btn'\n              size='mini'\n              onClick={() => runTest('test-payment', 'æ”¯ä»˜é€šçŸ¥')}\n              disabled={isLoading}\n            >\n              æ”¯ä»˜é€šçŸ¥\n            </Button>\n            <Button \n              className='test-btn'\n              size='mini'\n              onClick={() => runTest('test-maintenance', 'ç³»ç»Ÿç»´æŠ¤')}\n              disabled={isLoading}\n            >\n              ç³»ç»Ÿç»´æŠ¤\n            </Button>\n            <Button \n              className='test-btn'\n              size='mini'\n              onClick={() => runTest('test-priorities', 'ä¼˜å…ˆçº§æµ‹è¯•')}\n              disabled={isLoading}\n            >\n              ä¼˜å…ˆçº§æµ‹è¯•\n            </Button>\n          </View>\n        </View>\n\n        <View className='control-section'>\n          <Text className='section-title'>ç»¼åˆæµ‹è¯•</Text>\n          <View className='button-row'>\n            <Button \n              className='test-btn primary'\n              size='mini'\n              onClick={runFullSuite}\n              disabled={isLoading}\n            >\n              {isLoading ? 'æµ‹è¯•ä¸­...' : 'è¿è¡Œå®Œæ•´æµ‹è¯•'}\n            </Button>\n          </View>\n        </View>\n      </View>\n\n      <View className='test-results'>\n        <View className='results-header'>\n          <Text className='results-title'>æµ‹è¯•ç»“æœ</Text>\n          <Button \n            className='clear-btn'\n            size='mini'\n            onClick={clearResults}\n          >\n            æ¸…ç©º\n          </Button>\n        </View>\n        \n        <View className='results-content'>\n          {testResults.length > 0 ? (\n            testResults.map((result, index) => (\n              <View key={index} className='result-item'>\n                <Text className='result-text'>{result}</Text>\n              </View>\n            ))\n          ) : (\n            <View className='empty-results'>\n              <Text className='empty-text'>æš‚æ— æµ‹è¯•ç»“æœ</Text>\n            </View>\n          )}\n        </View>\n      </View>\n\n      <View className='test-instructions'>\n        <Text className='instructions-title'>ä½¿ç”¨è¯´æ˜</Text>\n        <Text className='instructions-text'>\n          1. ç¡®ä¿WebSocketè¿æ¥æ­£å¸¸ï¼ˆçŠ¶æ€æ˜¾ç¤ºä¸º\"å·²è¿æ¥\"ï¼‰{\"\\n\"}\n          2. ç‚¹å‡»å„ç§æµ‹è¯•æŒ‰é’®å‘é€æµ‹è¯•é€šçŸ¥{\"\\n\"}\n          3. è§‚å¯Ÿé€šçŸ¥ä¸­å¿ƒæ˜¯å¦æ”¶åˆ°å®æ—¶é€šçŸ¥{\"\\n\"}\n          4. æ£€æŸ¥é€šçŸ¥çš„å†…å®¹ã€ä¼˜å…ˆçº§å’Œæ—¶é—´æ˜¯å¦æ­£ç¡®{\"\\n\"}\n          5. æµ‹è¯•æ ‡è®°å·²è¯»ã€åˆ é™¤ç­‰åŠŸèƒ½æ˜¯å¦æ­£å¸¸\n        </Text>\n      </View>\n    </View>\n  )\n}\n\nexport default NotificationTest"