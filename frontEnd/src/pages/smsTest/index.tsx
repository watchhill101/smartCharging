import { View, Text, Button, Input } from '@tarojs/components'\nimport { useState } from 'react'\nimport Taro from '@tarojs/taro'\nimport request from '../../utils/request'\nimport SmsSettings from '../../components/SmsSettings'\nimport './index.scss'\n\nconst SmsTest: React.FC = () => {\n  const [phoneNumber, setPhoneNumber] = useState('')\n  const [isLoading, setIsLoading] = useState(false)\n  const [testResults, setTestResults] = useState<string[]>([])\n  const [showSettings, setShowSettings] = useState(false)\n\n  const addTestResult = (message: string) => {\n    setTestResults(prev => [...prev, `${new Date().toLocaleTimeString()}: ${message}`])\n  }\n\n  const handlePhoneNumberChange = (e: any) => {\n    const value = e.detail.value.replace(/\\D/g, '') // åªä¿ç•™æ•°å­—\n    if (value.length <= 11) {\n      setPhoneNumber(value)\n    }\n  }\n\n  const validatePhoneNumber = (): boolean => {\n    if (!phoneNumber) {\n      showToast({\n        title: 'è¯·è¾“å…¥æ‰‹æœºå·',\n        icon: 'error'\n      })\n      return false\n    }\n    \n    if (!/^1[3-9]\\d{9}$/.test(phoneNumber)) {\n      showToast({\n        title: 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®',\n        icon: 'error'\n      })\n      return false\n    }\n    \n    return true\n  }\n\n  const runSmsTest = async (testType: string, testName: string, requireAuth: boolean = true) => {\n    if (!validatePhoneNumber()) return\n    \n    setIsLoading(true)\n    addTestResult(`å¼€å§‹${testName}æµ‹è¯•...`)\n    \n    try {\n      const response = await request({\n        url: `/sms-test/${testType}`,\n        method: 'POST',\n        data: { phoneNumber }\n      })\n\n      if (response.data.success) {\n        addTestResult(`âœ… ${testName}æµ‹è¯•æˆåŠŸ: ${response.data.message}`)\n        if (response.data.data?.code) {\n          addTestResult(`   éªŒè¯ç : ${response.data.data.code}`)\n        }\n      } else {\n        addTestResult(`âŒ ${testName}æµ‹è¯•å¤±è´¥: ${response.data.message}`)\n      }\n    } catch (error: any) {\n      console.error(`${testName}æµ‹è¯•å¤±è´¥:`, error)\n      addTestResult(`âŒ ${testName}æµ‹è¯•å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`)\n    } finally {\n      setIsLoading(false)\n    }\n  }\n\n  const runFullSuite = async () => {\n    if (!validatePhoneNumber()) return\n    \n    setIsLoading(true)\n    addTestResult('å¼€å§‹è¿è¡Œå®Œæ•´çŸ­ä¿¡æµ‹è¯•å¥—ä»¶...')\n    \n    try {\n      const response = await request({\n        url: '/sms-test/run-full-suite',\n        method: 'POST',\n        data: { phoneNumber }\n      })\n\n      if (response.data.success) {\n        addTestResult(`âœ… æµ‹è¯•å¥—ä»¶å®Œæˆ: ${response.data.message}`)\n        \n        const { summary } = response.data.data\n        addTestResult(`   æ€»è®¡: ${summary.total} æ¡`)\n        addTestResult(`   æˆåŠŸ: ${summary.success} æ¡`)\n        addTestResult(`   å¤±è´¥: ${summary.failed} æ¡`)\n        addTestResult(`   æˆåŠŸç‡: ${summary.successRate}`)\n      } else {\n        addTestResult(`âŒ æµ‹è¯•å¥—ä»¶å¤±è´¥: ${response.data.message}`)\n      }\n    } catch (error: any) {\n      console.error('æµ‹è¯•å¥—ä»¶å¤±è´¥:', error)\n      addTestResult(`âŒ æµ‹è¯•å¥—ä»¶å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`)\n    } finally {\n      setIsLoading(false)\n    }\n  }\n\n  const testSystemMaintenance = async () => {\n    if (!validatePhoneNumber()) return\n    \n    setIsLoading(true)\n    addTestResult('å¼€å§‹ç³»ç»Ÿç»´æŠ¤é€šçŸ¥æµ‹è¯•...')\n    \n    try {\n      const response = await request({\n        url: '/sms-test/test-system-maintenance',\n        method: 'POST',\n        data: { phoneNumbers: [phoneNumber] }\n      })\n\n      if (response.data.success) {\n        addTestResult(`âœ… ç³»ç»Ÿç»´æŠ¤é€šçŸ¥æµ‹è¯•æˆåŠŸ: ${response.data.message}`)\n      } else {\n        addTestResult(`âŒ ç³»ç»Ÿç»´æŠ¤é€šçŸ¥æµ‹è¯•å¤±è´¥: ${response.data.message}`)\n      }\n    } catch (error: any) {\n      console.error('ç³»ç»Ÿç»´æŠ¤é€šçŸ¥æµ‹è¯•å¤±è´¥:', error)\n      addTestResult(`âŒ ç³»ç»Ÿç»´æŠ¤é€šçŸ¥æµ‹è¯•å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`)\n    } finally {\n      setIsLoading(false)\n    }\n  }\n\n  const getSmsStatistics = async () => {\n    try {\n      const response = await request({\n        url: '/sms/statistics?timeRange=day',\n        method: 'GET'\n      })\n\n      if (response.data.success) {\n        const { statistics } = response.data.data\n        addTestResult('ğŸ“Š ä»Šæ—¥çŸ­ä¿¡ç»Ÿè®¡:')\n        addTestResult(`   æ€»è®¡: ${statistics.total} æ¡`)\n        addTestResult(`   æˆåŠŸ: ${statistics.sent} æ¡`)\n        addTestResult(`   å¤±è´¥: ${statistics.failed} æ¡`)\n        addTestResult(`   æˆåŠŸç‡: ${statistics.successRate.toFixed(1)}%`)\n      }\n    } catch (error: any) {\n      addTestResult(`âŒ è·å–ç»Ÿè®¡å¤±è´¥: ${error.message}`)\n    }\n  }\n\n  const clearResults = () => {\n    setTestResults([])\n  }\n\n  return (\n    <View className='sms-test'>\n      <View className='test-header'>\n        <Text className='page-title'>çŸ­ä¿¡é€šçŸ¥æµ‹è¯•</Text>\n        <Button \n          className='settings-btn'\n          size='mini'\n          onClick={() => setShowSettings(true)}\n        >\n          è®¾ç½®\n        </Button>\n      </View>\n\n      <View className='phone-input-section'>\n        <Text className='input-label'>æµ‹è¯•æ‰‹æœºå·</Text>\n        <Input\n          className='phone-input'\n          type='number'\n          placeholder='è¯·è¾“å…¥11ä½æ‰‹æœºå·ç '\n          value={phoneNumber}\n          onInput={handlePhoneNumberChange}\n          maxlength={11}\n        />\n        {phoneNumber && (\n          <Text className='phone-hint'>\n            {/^1[3-9]\\d{9}$/.test(phoneNumber) ? 'âœ… æ‰‹æœºå·æ ¼å¼æ­£ç¡®' : 'âŒ æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®'}\n          </Text>\n        )}\n      </View>\n\n      <View className='test-controls'>\n        <View className='control-section'>\n          <Text className='section-title'>åŸºç¡€åŠŸèƒ½æµ‹è¯•</Text>\n          <View className='button-grid'>\n            <Button \n              className='test-btn'\n              size='mini'\n              onClick={() => runSmsTest('test-verification-code', 'éªŒè¯ç çŸ­ä¿¡', false)}\n              disabled={isLoading}\n            >\n              éªŒè¯ç çŸ­ä¿¡\n            </Button>\n            <Button \n              className='test-btn'\n              size='mini'\n              onClick={() => runSmsTest('test-charging-started', 'å……ç”µå¼€å§‹')}\n              disabled={isLoading}\n            >\n              å……ç”µå¼€å§‹\n            </Button>\n            <Button \n              className='test-btn'\n              size='mini'\n              onClick={() => runSmsTest('test-charging-completed', 'å……ç”µå®Œæˆ')}\n              disabled={isLoading}\n            >\n              å……ç”µå®Œæˆ\n            </Button>\n            <Button \n              className='test-btn'\n              size='mini'\n              onClick={() => runSmsTest('test-charging-failed', 'å……ç”µå¼‚å¸¸')}\n              disabled={isLoading}\n            >\n              å……ç”µå¼‚å¸¸\n            </Button>\n          </View>\n        </View>\n\n        <View className='control-section'>\n          <Text className='section-title'>æ”¯ä»˜ç›¸å…³æµ‹è¯•</Text>\n          <View className='button-grid'>\n            <Button \n              className='test-btn'\n              size='mini'\n              onClick={() => runSmsTest('test-payment-success', 'æ”¯ä»˜æˆåŠŸ')}\n              disabled={isLoading}\n            >\n              æ”¯ä»˜æˆåŠŸ\n            </Button>\n            <Button \n              className='test-btn'\n              size='mini'\n              onClick={() => runSmsTest('test-payment-failed', 'æ”¯ä»˜å¤±è´¥')}\n              disabled={isLoading}\n            >\n              æ”¯ä»˜å¤±è´¥\n            </Button>\n            <Button \n              className='test-btn'\n              size='mini'\n              onClick={() => runSmsTest('test-balance-low', 'ä½™é¢ä¸è¶³')}\n              disabled={isLoading}\n            >\n              ä½™é¢ä¸è¶³\n            </Button>\n          </View>\n        </View>\n\n        <View className='control-section'>\n          <Text className='section-title'>ä¼˜æƒ åˆ¸æµ‹è¯•</Text>\n          <View className='button-grid'>\n            <Button \n              className='test-btn'\n              size='mini'\n              onClick={() => runSmsTest('test-coupon-received', 'ä¼˜æƒ åˆ¸åˆ°è´¦')}\n              disabled={isLoading}\n            >\n              ä¼˜æƒ åˆ¸åˆ°è´¦\n            </Button>\n            <Button \n              className='test-btn'\n              size='mini'\n              onClick={() => runSmsTest('test-coupon-expiring', 'ä¼˜æƒ åˆ¸è¿‡æœŸ')}\n              disabled={isLoading}\n            >\n              ä¼˜æƒ åˆ¸è¿‡æœŸ\n            </Button>\n          </View>\n        </View>\n\n        <View className='control-section'>\n          <Text className='section-title'>ç³»ç»ŸåŠŸèƒ½æµ‹è¯•</Text>\n          <View className='button-row'>\n            <Button \n              className='test-btn'\n              size='mini'\n              onClick={testSystemMaintenance}\n              disabled={isLoading}\n            >\n              ç³»ç»Ÿç»´æŠ¤é€šçŸ¥\n            </Button>\n            <Button \n              className='test-btn'\n              size='mini'\n              onClick={getSmsStatistics}\n              disabled={isLoading}\n            >\n              è·å–ç»Ÿè®¡ä¿¡æ¯\n            </Button>\n          </View>\n        </View>\n\n        <View className='control-section'>\n          <Text className='section-title'>ç»¼åˆæµ‹è¯•</Text>\n          <View className='button-row'>\n            <Button \n              className='test-btn primary'\n              size='mini'\n              onClick={runFullSuite}\n              disabled={isLoading}\n            >\n              {isLoading ? 'æµ‹è¯•ä¸­...' : 'è¿è¡Œå®Œæ•´æµ‹è¯•'}\n            </Button>\n          </View>\n        </View>\n      </View>\n\n      <View className='test-results'>\n        <View className='results-header'>\n          <Text className='results-title'>æµ‹è¯•ç»“æœ</Text>\n          <Button \n            className='clear-btn'\n            size='mini'\n            onClick={clearResults}\n          >\n            æ¸…ç©º\n          </Button>\n        </View>\n        \n        <View className='results-content'>\n          {testResults.length > 0 ? (\n            testResults.map((result, index) => (\n              <View key={index} className='result-item'>\n                <Text className='result-text'>{result}</Text>\n              </View>\n            ))\n          ) : (\n            <View className='empty-results'>\n              <Text className='empty-text'>æš‚æ— æµ‹è¯•ç»“æœ</Text>\n            </View>\n          )}\n        </View>\n      </View>\n\n      <View className='test-instructions'>\n        <Text className='instructions-title'>ä½¿ç”¨è¯´æ˜</Text>\n        <Text className='instructions-text'>\n          1. è¾“å…¥æœ‰æ•ˆçš„11ä½æ‰‹æœºå·ç {\"\\n\"}\n          2. ç‚¹å‡»å„ç§æµ‹è¯•æŒ‰é’®å‘é€æµ‹è¯•çŸ­ä¿¡{\"\\n\"}\n          3. æŸ¥çœ‹æ‰‹æœºæ˜¯å¦æ”¶åˆ°çŸ­ä¿¡é€šçŸ¥{\"\\n\"}\n          4. åœ¨è®¾ç½®ä¸­å¯ä»¥é…ç½®çŸ­ä¿¡é€šçŸ¥åå¥½{\"\\n\"}\n          5. æµ‹è¯•ç¯å¢ƒä½¿ç”¨æ¨¡æ‹Ÿå‘é€ï¼Œå®é™…ä¸ä¼šäº§ç”Ÿè´¹ç”¨\n        </Text>\n      </View>\n\n      <SmsSettings \n        visible={showSettings}\n        onClose={() => setShowSettings(false)}\n      />\n    </View>\n  )\n}\n\nexport default SmsTest"
import { showToast } from '../utils/toast'