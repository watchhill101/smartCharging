# 地图跳转功能修复说明

## 问题描述
之前从 `CitySelector.tsx` 和 `xiangx.tsx` 跳转到地图页面时，地图没有正确显示目标位置信息。

## 问题原因
1. **CitySelector.tsx**: 定位功能获取到城市信息后，只更新了城市名称，没有保存坐标信息
2. **地图页面**: Device组件的useEffect依赖数组为空，当props变化时不会重新初始化地图
3. **数据传递**: 缺少从城市选择器到地图页面的坐标数据传递

## 修复内容

### 1. CitySelector.tsx 修复
- 在 `locationInfo` 接口中添加了 `coordinates?: [number, number]` 字段
- 修改 `getCurrentLocation` 函数，保存获取到的坐标信息
- 在定位成功后，将坐标信息保存到存储中
- 在定位信息显示区域添加了"查看地图"按钮，可以直接跳转到地图页面
- 添加了相应的CSS样式，使新增功能更美观

### 2. 地图页面修复
- 修复了 Device 组件的 useEffect 依赖数组，添加了 `[props.initialCoord, props.stationInfo]`
- 确保当坐标或站点信息变化时，地图会重新初始化并显示正确位置

### 3. 数据流程优化
- CitySelector 定位成功后，保存位置信息到 `current_location` 存储
- 点击"查看地图"时，将坐标和位置信息保存到 `map_target_coord` 和 `map_target_station`
- 地图页面读取这些存储数据，正确显示目标位置

## 使用方法

### 从城市选择器跳转到地图
1. 在城市选择器页面点击"重新定位"
2. 定位成功后，会显示坐标信息和"查看地图"按钮
3. 点击"查看地图"按钮，跳转到地图页面
4. 地图页面会显示定位到的位置，并标记为"我的位置"

### 从充电站详情跳转到地图
1. 在充电站详情页面点击"导航"按钮
2. 系统会自动保存充电站坐标和站点信息
3. 跳转到地图页面，显示充电站位置
4. 地图页面会显示充电站信息卡片

## 技术细节

### 存储键名
- `current_location`: 存储用户当前位置信息
- `map_target_coord`: 存储地图目标坐标
- `map_target_station`: 存储地图目标站点信息

### 坐标格式
- 经度 (longitude): 东经为正，西经为负
- 纬度 (latitude): 北纬为正，南纬为负
- 使用高德地图坐标系 (GCJ-02)

### 兼容性
- 支持 Taro 环境 (小程序、H5)
- 降级支持浏览器 localStorage
- 自动检测环境并使用相应的API

## 测试建议
1. 测试城市选择器的定位功能
2. 测试从城市选择器跳转到地图
3. 测试从充电站详情跳转到地图
4. 测试不同环境下的兼容性 (Taro vs 浏览器)

## 注意事项
- H5环境需要HTTPS才能使用定位功能
- 定位权限被拒绝时，会显示相应的错误提示
- 坐标信息会自动保存，下次打开地图时会显示上次的位置
